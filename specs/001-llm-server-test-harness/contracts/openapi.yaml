openapi: 3.0.3
info:
  title: LLM Test Harness API
  version: 1.0.0
servers:
  - url: http://localhost:8080
security:
  - ApiTokenAuth: []
components:
  securitySchemes:
    ApiTokenAuth:
      type: apiKey
      in: header
      name: X-API-Token
  schemas:
    Target:
      type: object
      required: [id, name, base_url]
      properties:
        id: { type: string }
        name: { type: string }
        base_url: { type: string }
        auth_type: { type: string }
        default_model: { type: string }
        default_params: { type: object }
        timeouts: { type: object }
        concurrency_limit: { type: integer }
    TestDefinition:
      type: object
      required: [id, version, name, runner_type]
      properties:
        id: { type: string }
        version: { type: string }
        name: { type: string }
        description: { type: string }
        runner_type: { type: string, enum: [json, python] }
        tags: { type: array, items: { type: string } }
        protocols: { type: array, items: { type: string } }
    Suite:
      type: object
      required: [id, name]
      properties:
        id: { type: string }
        name: { type: string }
        ordered_test_ids:
          type: array
          items: { type: string }
        stop_on_fail: { type: boolean }
    Profile:
      type: object
      required: [id, name, version]
      properties:
        id: { type: string }
        name: { type: string }
        version: { type: string }
        generation_parameters: { type: object }
        context_strategy: { type: object }
        test_selection: { type: object }
        execution_behaviour: { type: object }
    Run:
      type: object
      required: [id, status, started_at]
      properties:
        id: { type: string }
        target_id: { type: string }
        test_id: { type: string }
        suite_id: { type: string }
        profile_id: { type: string }
        status: { type: string, enum: [queued, running, completed, failed, canceled] }
        started_at: { type: string, format: date-time }
        ended_at: { type: string, format: date-time }
    TestResult:
      type: object
      required: [id, run_id, test_id, verdict]
      properties:
        id: { type: string }
        run_id: { type: string }
        test_id: { type: string }
        verdict: { type: string, enum: [pass, fail, skip] }
        failure_reason: { type: string }
        metrics: { type: object }
        artefacts: { type: object }
        raw_events: { type: array, items: { type: object } }
    Model:
      type: object
      required: [id, name, provider]
      properties:
        id: { type: string }
        name: { type: string }
        provider: { type: string }
        version: { type: string }
        architecture: { type: object }
        quantisation: { type: object }
        capabilities: { type: object }
        raw_metadata: { type: object }
paths:
  /health:
    get:
      summary: Health check
      responses:
        '200': { description: OK }
  /targets:
    get:
      summary: List targets
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Target' }
    post:
      summary: Create target
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Target' }
      responses:
        '201': { description: Created }
  /targets/{targetId}:
    get:
      summary: Get target
      parameters:
        - in: path
          name: targetId
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
    put:
      summary: Update target
      parameters:
        - in: path
          name: targetId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Target' }
      responses:
        '200': { description: OK }
    delete:
      summary: Delete target
      parameters:
        - in: path
          name: targetId
          required: true
          schema: { type: string }
      responses:
        '204': { description: Deleted }
  /tests:
    get:
      summary: List tests
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TestDefinition' }
  /tests/reload:
    post:
      summary: Reload tests from disk
      responses:
        '200': { description: OK }
  /suites:
    get:
      summary: List suites
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Suite' }
    post:
      summary: Create suite
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Suite' }
      responses:
        '201': { description: Created }
  /suites:
    get:
      summary: List suites
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Suite' }
    post:
      summary: Create suite
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Suite' }
      responses:
        '201': { description: Created }
  /suites/{suiteId}:
    get:
      summary: Get suite
      parameters:
        - in: path
          name: suiteId
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
    put:
      summary: Update suite
      parameters:
        - in: path
          name: suiteId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Suite' }
      responses:
        '200': { description: OK }
    delete:
      summary: Delete suite
      parameters:
        - in: path
          name: suiteId
          required: true
          schema: { type: string }
      responses:
        '204': { description: Deleted }
  /profiles:
    get:
      summary: List profiles
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Profile' }
    post:
      summary: Create profile
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Profile' }
      responses:
        '201': { description: Created }
  /profiles/{profileId}:
    get:
      summary: Get profile
      parameters:
        - in: path
          name: profileId
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
    put:
      summary: Update profile
      parameters:
        - in: path
          name: profileId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Profile' }
      responses:
        '200': { description: OK }
    delete:
      summary: Delete profile
      parameters:
        - in: path
          name: profileId
          required: true
          schema: { type: string }
      responses:
        '204': { description: Deleted }
  /runs:
    post:
      summary: Start a run
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [target_id]
              properties:
                target_id: { type: string }
                test_id: { type: string }
                suite_id: { type: string }
                profile_id: { type: string }
                profile_version: { type: string }
                repetitions: { type: integer }
                continue_on_failure: { type: boolean }
      responses:
        '202': { description: Accepted }
    get:
      summary: List runs
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Run' }
  /runs/{runId}:
    get:
      summary: Get run
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
  /runs/{runId}/results:
    get:
      summary: List results for a run
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TestResult' }
  /results/{resultId}:
    get:
      summary: Get a test result
      parameters:
        - in: path
          name: resultId
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
  /profiles:
    get:
      summary: List profiles
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Profile' }
    post:
      summary: Create profile
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Profile' }
      responses:
        '201': { description: Created }
  /models:
    get:
      summary: List models
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Model' }
  /export:
    post:
      summary: Export results
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                format: { type: string, enum: [json, csv] }
                run_id: { type: string }
                target_id: { type: string }
      responses:
        '200': { description: OK }
